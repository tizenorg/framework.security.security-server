--PRAGMA journal_mode = PERSIST;

BEGIN EXCLUSIVE TRANSACTION;

CREATE TABLE IF NOT EXISTS tizen_version (
    tizen_version_id INTEGER PRIMARY KEY,
    tizen_version MEDIUMTEXT UNIQUE NOT NULL
);

INSERT OR IGNORE INTO tizen_version (tizen_version) VALUES (@TIZEN_VERSION@);

--Alter table with constraints is not supported by SQLite, hence this hack
ALTER TABLE app RENAME TO backup_app;
CREATE TABLE IF NOT EXISTS  app (
    app_id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT,
    label_id INTEGER NOT NULL,
    tizen_version_id INTEGER NOT NULL,
    UNIQUE(label_id),

    FOREIGN KEY(label_id) REFERENCES label(label_id),
    FOREIGN KEY(tizen_version_id) REFERENCES tizen_version(tizen_version_id)
);

CREATE TEMPORARY VIEW tmp_app_view AS
SELECT app_id, label_id, tizen_version FROM app
INNER JOIN tizen_version USING(tizen_version_id);

CREATE TRIGGER tmp_app_insert_trigger
INSTEAD OF INSERT ON tmp_app_view
BEGIN
INSERT OR IGNORE INTO tizen_version(tizen_version) VALUES (NEW.tizen_version);
INSERT INTO app(app_id,label_id,tizen_version_id)
VALUES (NEW.app_id, NEW.label_id,
(SELECT tizen_version_id FROM tizen_version
WHERE tizen_version.tizen_version=IFNULL(NEW.tizen_version,@TIZEN_VERSION@)));
END;


INSERT INTO tmp_app_view(app_id, label_id)
SELECT * FROM backup_app;

ALTER TABLE permission RENAME TO backup_permission;
CREATE TABLE IF NOT EXISTS permission (
    permission_id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT ,
    permission_type_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    tizen_version_id INTEGER NOT NULL,

    UNIQUE (name, permission_type_id, tizen_version_id),

    FOREIGN KEY(permission_type_id) REFERENCES permission_type(permission_type_id),
    FOREIGN KEY(tizen_version_id) REFERENCES tizen_version(tizen_version_id)
);

CREATE TEMPORARY VIEW tmp_permission_view AS
SELECT permission_id, permission_type_id, name, tizen_version FROM permission
INNER JOIN tizen_version USING(tizen_version_id);

CREATE TRIGGER tmp_permission_insert_trigger
INSTEAD OF INSERT ON tmp_permission_view
BEGIN
INSERT OR IGNORE INTO tizen_version(tizen_version) VALUES (NEW.tizen_version);
INSERT INTO permission(permission_id,permission_type_id,name,tizen_version_id)
VALUES (NEW.permission_id, NEW.permission_type_id, NEW.name,
(SELECT tizen_version_id FROM tizen_version
WHERE tizen_version.tizen_version=IFNULL(NEW.tizen_version,@TIZEN_VERSION@)));
END;

INSERT INTO tmp_permission_view (permission_id, permission_type_id, name)
 SELECT * FROM backup_permission;

DROP TABLE backup_app;
DROP TABLE backup_permission;

--assume, that database is in version V3
PRAGMA user_version = 4;

COMMIT TRANSACTION;
