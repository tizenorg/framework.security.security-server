--PRAGMA journal_mode = PERSIST;

BEGIN EXCLUSIVE TRANSACTION;

ALTER TABLE app_permission ADD COLUMN is_blacklist_enabled INTEGER NOT NULL DEFAULT 0;

ALTER TABLE permission ADD COLUMN on_blacklist INTEGER NOT NULL DEFAULT 0;

-- BLACKLIST VIEW
-- Assume permission version == app version
DROP VIEW IF EXISTS app_permission_blacklist_view;
CREATE VIEW app_permission_blacklist_view AS
SELECT      application_view.name AS app_name,
            application_view.app_id,
            app_permission.is_blacklist_enabled,
            app_permission.permission_id,
            permission.name,
            permission.on_blacklist,
            permission.permission_type_id,
            permission_type.type_name
FROM        application_view
INNER JOIN  app_permission USING(app_id)
INNER JOIN  permission USING(permission_id)
INNER JOIN  permission_type USING(permission_type_id)
WHERE       permission.on_blacklist = 1;


--assume, that database is in version V4
PRAGMA user_version = 5;

COMMIT TRANSACTION;
